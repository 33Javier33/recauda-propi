<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Recaudaci√≥n Pro - Gesti√≥n Profesional</title>
    
    <!-- PWA & META -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5855f6">
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#5855f6",
                        "background-light": "#f6f5f8",
                        "background-dark": "#101022",
                        "surface-dark": "#191834",
                        "border-dark": "#323168",
                        "accent-amber": "#f59e0b",
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .content-panel { display: none; }
        .content-panel.active { display: block; animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Estilos Toast Originales adaptados */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #1e293b; color: white; padding: 12px 24px; border-radius: 14px; font-weight: 600; font-size: 0.9rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 12px; animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-100px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 min-h-screen">

    <div id="toast-container"></div>

    <!-- GLOBAL LOADER -->
    <div id="globalLoader" class="fixed inset-0 bg-background-dark/80 backdrop-blur-md hidden items-center justify-center z-[10000]">
        <div class="text-center">
            <div class="inline-block size-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin"></div>
            <p id="loaderMsg" class="mt-4 text-primary font-bold tracking-widest text-sm uppercase">Sincronizando...</p>
        </div>
    </div>

    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay" class="fixed inset-0 z-[9999] bg-background-dark flex items-center justify-center p-6">
        <div class="w-full max-w-md bg-surface-dark p-8 rounded-[2.5rem] border border-border-dark shadow-2xl text-center">
            <div class="size-20 bg-primary/20 rounded-3xl flex items-center justify-center mb-6 mx-auto border border-primary/30">
                <span class="material-symbols-outlined text-primary text-4xl">shield_person</span>
            </div>
            <h2 class="text-3xl font-black mb-2 tracking-tight">Acceso</h2>
            <p class="text-slate-400 mb-8 text-sm">Seleccione su perfil de trabajo</p>
            <form id="loginForm" class="space-y-4 text-left">
                <select id="username" class="w-full bg-background-dark border-border-dark rounded-2xl py-4 px-5 focus:ring-2 focus:ring-primary text-white font-bold">
                    <option value="" disabled selected>Elegir Usuario...</option>
                    <option value="mesas">USUARIO: MESAS</option>
                    <option value="maquinas">USUARIO: M√ÅQUINAS</option>
                </select>
                <div class="relative">
                    <input type="password" id="password" placeholder="Clave de Seguridad" class="w-full bg-background-dark border-border-dark rounded-2xl py-4 px-5 focus:ring-2 focus:ring-primary text-white">
                    <span id="toggleLoginPassword" class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 cursor-pointer">visibility</span>
                </div>
                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white py-5 rounded-2xl font-black text-lg transition-all active:scale-95 shadow-xl shadow-primary/20">
                    INGRESAR
                </button>
            </form>
        </div>
    </div>

    <!-- HEADER TOP BAR -->
    <header class="sticky top-0 z-40 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md border-b border-slate-200 dark:border-border-dark">
        <div class="flex items-center justify-between p-4 max-w-2xl mx-auto">
            <div class="flex items-center gap-3">
                <div class="size-10 rounded-xl bg-primary/20 flex items-center justify-center border border-primary/30">
                    <span class="material-symbols-outlined text-primary">analytics</span>
                </div>
                <div>
                    <h1 id="panelTitle" class="text-lg font-black tracking-tight leading-none">Recaudaci√≥n Pro</h1>
                    <p id="activeUserBadge" class="text-[10px] text-primary font-bold uppercase tracking-widest mt-1">Cargando...</p>
                </div>
            </div>
            <button id="logoutBtn" class="flex items-center gap-2 bg-red-500/10 text-red-500 px-4 py-2 rounded-full text-xs font-bold hover:bg-red-500 hover:text-white transition-all">
                CERRAR <span class="material-symbols-outlined text-sm">power_settings_new</span>
            </button>
        </div>
    </header>

    <main id="mainContent" class="max-w-2xl mx-auto pb-32 hidden">
        
        <!-- DASHBOARD STATS -->
        <div class="p-4 grid grid-cols-2 gap-4">
            <div class="bg-white dark:bg-surface-dark p-5 rounded-3xl border border-slate-200 dark:border-border-dark shadow-sm">
                <span class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Recaudaci√≥n Total</span>
                <p id="tot-rec" class="text-2xl font-black text-primary mt-1">$0</p>
            </div>
            <div class="bg-white dark:bg-surface-dark p-5 rounded-3xl border border-slate-200 dark:border-border-dark shadow-sm">
                <span class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Valor por Punto</span>
                <p id="tot-div" class="text-2xl font-black text-accent-amber mt-1">$0</p>
            </div>
        </div>

        <!-- PANEL: AGREGAR -->
        <section id="agregarPanel" class="content-panel active p-4 space-y-6">
            <div class="bg-white dark:bg-surface-dark p-8 rounded-[2.5rem] border border-slate-200 dark:border-border-dark shadow-2xl">
                <h3 class="text-xl font-black mb-8 flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary">add_circle</span> NUEVO REGISTRO
                </h3>
                <form id="agregarForm" class="space-y-6">
                    <div class="grid grid-cols-3 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="tipo" value="M√°quinas" checked class="peer hidden">
                            <div class="peer-checked:bg-primary peer-checked:text-white bg-slate-100 dark:bg-background-dark p-4 rounded-2xl text-center border-2 border-transparent peer-checked:border-primary/50 transition-all">
                                <span class="material-symbols-outlined block mb-1">slot_machine</span>
                                <p class="text-[10px] font-black uppercase">M√°quinas</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="tipo" value="Mesas" class="peer hidden">
                            <div class="peer-checked:bg-primary peer-checked:text-white bg-slate-100 dark:bg-background-dark p-4 rounded-2xl text-center border-2 border-transparent peer-checked:border-primary/50 transition-all">
                                <span class="material-symbols-outlined block mb-1">casino</span>
                                <p class="text-[10px] font-black uppercase">Mesas</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="tipo" value="Otras" class="peer hidden">
                            <div class="peer-checked:bg-primary peer-checked:text-white bg-slate-100 dark:bg-background-dark p-4 rounded-2xl text-center border-2 border-transparent peer-checked:border-primary/50 transition-all">
                                <span class="material-symbols-outlined block mb-1">more_horiz</span>
                                <p class="text-[10px] font-black uppercase">Otras</p>
                            </div>
                        </label>
                    </div>

                    <div class="space-y-2">
                        <label class="text-[11px] font-black text-slate-500 uppercase ml-2 tracking-widest">Fecha</label>
                        <input type="date" id="fecha" required class="w-full bg-slate-50 dark:bg-background-dark border-slate-200 dark:border-border-dark rounded-2xl py-4 focus:ring-primary text-white font-bold">
                    </div>

                    <div class="space-y-2">
                        <label class="text-[11px] font-black text-slate-500 uppercase ml-2 tracking-widest">Monto Recaudado</label>
                        <div class="relative">
                            <span class="absolute left-5 top-1/2 -translate-y-1/2 font-black text-primary text-xl">$</span>
                            <input type="tel" id="monto" oninput="formatearMonto(this)" placeholder="0" required class="w-full bg-slate-50 dark:bg-background-dark border-slate-200 dark:border-border-dark rounded-2xl py-5 pl-12 text-2xl font-black text-white focus:ring-primary">
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-primary text-white py-5 rounded-2xl font-black text-lg shadow-xl shadow-primary/30 active:scale-95 transition-all uppercase tracking-widest">
                        Guardar Registro
                    </button>
                </form>
            </div>
        </section>

        <!-- PANEL: HISTORIAL -->
        <section id="historialPanel" class="content-panel p-4 space-y-4">
            <div class="flex flex-wrap gap-2 mb-4">
                <button id="btnMin" class="bg-white dark:bg-surface-dark border border-border-dark px-4 py-2 rounded-full text-[10px] font-black uppercase">Expandir/Min</button>
                <button id="btnSortDesc" class="bg-white dark:bg-surface-dark border border-border-dark px-4 py-2 rounded-full text-[10px] font-black uppercase">Reciente</button>
                <input type="text" id="filtro" placeholder="Buscar fecha..." class="flex-1 bg-white dark:bg-surface-dark border-slate-200 dark:border-border-dark rounded-full px-5 py-2 text-xs">
            </div>

            <div id="tablaContainer" class="space-y-6">
                <!-- Grupos de fecha generados por JS -->
            </div>

            <!-- BACKUP ACTIONS ORIGINALES -->
            <div class="mt-12 p-6 bg-white dark:bg-surface-dark rounded-[2rem] border border-border-dark space-y-4">
                <h4 class="text-xs font-black uppercase tracking-widest text-slate-500">Gesti√≥n de Datos</h4>
                <div class="grid grid-cols-2 gap-3">
                    <button id="btnExport" class="bg-slate-100 dark:bg-background-dark py-3 rounded-xl text-[10px] font-bold uppercase border border-border-dark">Exportar Backup</button>
                    <button id="btnImportTrigger" class="bg-slate-100 dark:bg-background-dark py-3 rounded-xl text-[10px] font-bold uppercase border border-border-dark text-accent-amber">Importar JSON</button>
                    <button id="btnLimpiar" class="bg-red-500/10 text-red-500 py-3 rounded-xl text-[10px] font-bold uppercase border border-red-500/20 col-span-2">Vaciar Todo</button>
                </div>
                <input type="file" id="jsonInput" class="hidden" accept=".json">
            </div>
        </section>

        <!-- PANEL: NOTAS -->
        <section id="notasPanel" class="content-panel">
            <div class="p-6 bg-white dark:bg-background-dark border-b border-slate-200 dark:border-border-dark">
                <div class="flex gap-4">
                    <div id="userAvatar" class="size-12 shrink-0 rounded-2xl bg-primary flex items-center justify-center text-white font-black text-lg shadow-lg shadow-primary/20">??</div>
                    <div class="flex-1 space-y-3">
                        <textarea id="notaMsg" class="w-full bg-slate-100 dark:bg-surface-dark border-slate-200 dark:border-border-dark rounded-2xl p-4 text-sm min-h-[120px] resize-none focus:ring-primary" placeholder="Escribe un mensaje para el otro turno..."></textarea>
                        <div class="flex justify-end">
                            <button id="btnNota" class="bg-primary text-white px-8 py-3 rounded-xl font-black text-sm shadow-xl shadow-primary/20 active:scale-95 transition-all uppercase tracking-widest">Publicar Nota</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="notesContainer" class="p-4 space-y-4">
                <!-- Notas generadas por JS -->
            </div>
        </section>

        <!-- PANEL: IMPORTAR TEXTO -->
        <section id="importarPanel" class="content-panel p-4">
            <div class="bg-white dark:bg-surface-dark p-8 rounded-[2.5rem] border border-border-dark">
                <h3 class="text-xl font-black mb-4 uppercase tracking-tighter">Importar Reporte</h3>
                <p class="text-xs text-slate-500 mb-6">Pega el texto del reporte diario para procesar autom√°ticamente.</p>
                <textarea id="importText" rows="10" class="w-full bg-slate-50 dark:bg-background-dark border-slate-200 dark:border-border-dark rounded-2xl p-4 text-xs mb-4 font-mono" placeholder="Ejemplo: 10/02/2026 - M√°quinas: $100.000..."></textarea>
                <button id="btnProcesar" class="w-full bg-primary text-white py-4 rounded-2xl font-black uppercase tracking-widest">Procesar e Importar</button>
            </div>
        </section>

    </main>

    <!-- TAB BAR (iOS STYLE) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-background-dark/90 backdrop-blur-xl border-t border-slate-200 dark:border-border-dark px-6 pb-10 pt-4 z-50">
        <div class="flex items-center justify-between max-w-2xl mx-auto">
            <button class="nav-btn flex flex-col items-center gap-1 text-primary transition-all scale-110" data-target="agregarPanel">
                <span class="material-symbols-outlined font-bold">add_box</span>
                <span class="text-[9px] font-black uppercase tracking-tighter">Agregar</span>
            </button>
            <button class="nav-btn flex flex-col items-center gap-1 text-slate-400" data-target="historialPanel">
                <span class="material-symbols-outlined font-bold">history</span>
                <span class="text-[9px] font-black uppercase tracking-tighter">Historial</span>
            </button>
            <button class="nav-btn flex flex-col items-center gap-1 text-slate-400 relative" data-target="notasPanel">
                <span class="material-symbols-outlined font-bold">forum</span>
                <span class="text-[9px] font-black uppercase tracking-tighter">Notas</span>
                <span id="ind-notas" class="absolute -top-1 -right-1 size-2.5 bg-accent-amber rounded-full border-2 border-background-dark hidden"></span>
            </button>
            <button class="nav-btn flex flex-col items-center gap-1 text-slate-400" data-target="importarPanel">
                <span class="material-symbols-outlined font-bold">upload_file</span>
                <span class="text-[9px] font-black uppercase tracking-tighter">Importar</span>
            </button>
        </div>
    </nav>

    <!-- MODAL EDITAR -->
    <div id="editModal" class="fixed inset-0 z-[100] bg-background-dark/90 backdrop-blur-sm hidden items-center justify-center p-6">
        <div class="w-full max-w-sm bg-surface-dark p-8 rounded-[2.5rem] border border-border-dark shadow-2xl">
            <h3 class="text-xl font-black mb-6 uppercase">Editar Registro</h3>
            <div class="space-y-4">
                <select id="edTipo" class="w-full bg-background-dark border-border-dark rounded-xl py-3 text-white font-bold">
                    <option>M√°quinas</option><option>Mesas</option><option>Otras</option>
                </select>
                <input type="date" id="edFecha" class="w-full bg-background-dark border-border-dark rounded-xl py-3 text-white">
                <input type="tel" id="edMonto" oninput="formatearMonto(this)" class="w-full bg-background-dark border-border-dark rounded-xl py-4 text-2xl font-black text-primary text-center">
                <div class="flex gap-3 pt-4">
                    <button id="btnSaveEd" class="flex-1 bg-primary text-white py-4 rounded-xl font-black uppercase text-xs">Actualizar</button>
                    <button onclick="document.getElementById('editModal').classList.add('hidden')" class="flex-1 bg-slate-800 text-slate-400 py-4 rounded-xl font-black uppercase text-xs">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIRMACI√ìN ORIGINAL -->
    <div id="confirmModal" class="fixed inset-0 z-[100] bg-background-dark/90 backdrop-blur-sm hidden items-center justify-center p-6 text-center">
        <div class="w-full max-w-sm bg-surface-dark p-8 rounded-[2.5rem] border border-border-dark shadow-2xl">
            <h3 id="confirmTitle" class="text-xl font-black mb-2 uppercase">Confirmar</h3>
            <p id="confirmMsg" class="text-slate-400 text-sm mb-8 leading-relaxed"></p>
            <div class="flex gap-3">
                <button id="confirmBtnYes" class="flex-1 bg-red-500 text-white py-4 rounded-xl font-black uppercase text-xs">Eliminar</button>
                <button id="confirmBtnNo" class="flex-1 bg-slate-800 text-slate-400 py-4 rounded-xl font-black uppercase text-xs">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. SERVICE WORKER ORIGINAL ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('SW OK'))
                .catch(err => console.log('SW Error', err));
        }

        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz_kCb4aEe437zHGbRqnjCibw1NtAqfCbTNmsVPn9jaZOPBFaZ6-FwmiTLqVxq39X1P/exec';
        let datos = [], notes = [], divisores = {}, editIndex = -1, minimizado = true, sortOrder = 'desc', currentPanel = 'agregarPanel', currentUser = '';

        // --- 2. FUNCIONES UI ORIGINALES ---
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast`;
            toast.innerHTML = `<span class="material-symbols-outlined ${type === 'success' ? 'text-green-400' : 'text-red-400'}">${type === 'success' ? 'check_circle' : 'error'}</span> ${msg}`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 400); }, 3000);
        }

        function customConfirm(title, msg) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMsg').textContent = msg;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.getElementById('confirmBtnYes').onclick = () => { modal.classList.add('hidden'); resolve(true); };
                document.getElementById('confirmBtnNo').onclick = () => { modal.classList.add('hidden'); resolve(false); };
            });
        }

        function switchPanel(targetId) {
            currentPanel = targetId;
            document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === targetId) {
                    btn.classList.add('text-primary', 'scale-110');
                    btn.classList.remove('text-slate-400');
                } else {
                    btn.classList.remove('text-primary', 'scale-110');
                    btn.classList.add('text-slate-400');
                }
            });

            if (targetId === 'notasPanel') { 
                localStorage.setItem('lastNote', Date.now()); 
                document.getElementById('ind-notas').classList.add('hidden');
            }
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.onclick = () => switchPanel(btn.dataset.target);
        });

        const showLoad = (s, msg = "Sincronizando...") => { 
            document.getElementById('loaderMsg').textContent = msg;
            document.getElementById('globalLoader').style.display = s ? 'flex' : 'none'; 
        };

        const formatearMonto = (input) => {
            let v = input.value.replace(/\D/g, '');
            input.value = v ? parseInt(v).toLocaleString('es-ES') : '';
        };
        window.formatearMonto = formatearMonto;

        // --- 3. L√ìGICA MATEM√ÅTICA ORIGINAL (Math.floor) ---
        const fNum = (n) => `$${Math.floor(n || 0).toLocaleString('es-ES')}`;
        const fFec = (f) => {
            const d = new Date(f + 'T12:00:00');
            return d.toLocaleDateString('es-ES', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
        };

        // --- 4. API & SYNC ---
        async function api(params) {
            const url = new URL(SCRIPT_URL);
            Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
            return fetch(url).then(r => r.json());
        }

        async function post(data) {
            return fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify(data) }).then(r => r.json());
        }

        async function cargar(loader = true) {
            if(loader) showLoad(true);
            try {
                const [d, n, div] = await Promise.all([api({action:'get'}), api({action:'getNotes'}), api({action:'getDivisores'})]);
                datos = d.data || []; notes = n.data || []; divisores = div.data || {};
                render();
            } finally { if(loader) showLoad(false); }
        }

        // --- 5. RENDERIZADO ORIGINAL CON FUNCIONES RESTAURADAS ---
        function render() {
            const totalRec = datos.reduce((s, d) => s + d.monto, 0);
            document.getElementById('tot-rec').textContent = fNum(totalRec);
            
            const grouped = datos.reduce((acc, d) => { (acc[d.fecha] = acc[d.fecha] || []).push(d); return acc; }, {});
            const sorted = Object.keys(grouped).sort((a,b) => sortOrder === 'desc' ? new Date(b) - new Date(a) : new Date(a) - new Date(b));
            let totalGeneralPtos = 0;
            const container = document.getElementById('tablaContainer');
            container.innerHTML = '';

            sorted.forEach((fecha, i) => {
                const diaTot = grouped[fecha].reduce((s,d) => s + d.monto, 0);
                const divVal = divisores[fecha] || 0;
                const resDiv = divVal > 0 ? diaTot / divVal : 0;
                totalGeneralPtos += resDiv;

                const filtroVal = document.getElementById('filtro').value;
                if (filtroVal && !fecha.includes(filtroVal)) return;
                if (minimizado && i > 0 && !filtroVal) return;

                let rows = grouped[fecha].map(d => `
                    <div class="flex justify-between items-center py-3 border-b border-slate-100 dark:border-border-dark/30 last:border-0">
                        <div class="flex flex-col">
                            <span class="text-[10px] font-black text-primary uppercase">${d.tipo}</span>
                            <span class="text-sm font-bold">${fNum(d.monto)}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="abrirEd(${d.originalIndex})" class="size-8 rounded-lg bg-slate-100 dark:bg-background-dark flex items-center justify-center text-primary"><span class="material-symbols-outlined text-sm">edit</span></button>
                            <button onclick="borrar(${d.originalIndex})" class="size-8 rounded-lg bg-red-500/10 flex items-center justify-center text-red-500"><span class="material-symbols-outlined text-sm">delete</span></button>
                        </div>
                    </div>`).join('');

                container.innerHTML += `
                    <div class="bg-white dark:bg-surface-dark rounded-[2rem] border border-border-dark overflow-hidden shadow-sm">
                        <div class="p-5 bg-slate-50 dark:bg-background-dark/40 flex justify-between items-center border-b border-border-dark">
                            <h4 class="text-xs font-black uppercase text-primary tracking-tighter">${fFec(fecha)}</h4>
                            <button onclick="copyRep('${fecha}')" class="bg-primary/10 text-primary px-3 py-1.5 rounded-full text-[9px] font-black flex items-center gap-1">COPIAR <span class="material-symbols-outlined text-[12px]">content_copy</span></button>
                        </div>
                        <div class="px-6 py-2">${rows}</div>
                        <div class="p-6 bg-slate-50 dark:bg-background-dark/20 border-t border-border-dark flex flex-wrap justify-between items-center gap-4">
                            <div>
                                <span class="text-[9px] font-black text-slate-500 uppercase block">Total Noche</span>
                                <span class="text-lg font-black">${fNum(diaTot)}</span>
                            </div>
                            <div class="flex items-center gap-3 bg-white dark:bg-background-dark px-4 py-2 rounded-2xl border border-border-dark">
                                <span class="text-[9px] font-black uppercase text-slate-500">Ptos:</span>
                                <input type="number" value="${divVal||''}" onchange="updDiv('${fecha}', this.value)" class="w-12 bg-transparent border-0 p-0 text-sm font-black text-accent-amber focus:ring-0">
                            </div>
                            <div class="text-right">
                                <span class="text-[9px] font-black text-primary uppercase block">Res. Noche</span>
                                <span class="text-xl font-black text-accent-amber">${fNum(resDiv)}</span>
                            </div>
                        </div>
                    </div>`;
            });
            document.getElementById('tot-div').textContent = fNum(totalGeneralPtos);
            renderNotes();
        }

        function renderNotes() {
            const last = parseInt(localStorage.getItem('lastNote')) || 0;
            const container = document.getElementById('notesContainer');
            container.innerHTML = notes.slice().reverse().map(n => {
                const isNew = new Date(n.fecha).getTime() > last;
                if(isNew) document.getElementById('ind-notas').classList.remove('hidden');
                
                return `
                <div class="relative bg-white dark:bg-surface-dark p-6 rounded-[2rem] border-l-8 ${isNew?'border-accent-amber':'border-primary'} border shadow-sm">
                    <button onclick="borrarNota(${n.originalIndex})" class="absolute top-4 right-4 text-red-500/30 hover:text-red-500"><span class="material-symbols-outlined text-lg">delete</span></button>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="size-10 rounded-xl bg-primary/20 flex items-center justify-center text-primary font-black uppercase">${n.autor.substring(0,2)}</div>
                        <div>
                            <h4 class="text-xs font-black uppercase">${n.autor}</h4>
                            <p class="text-[10px] text-slate-500">${new Date(n.fecha).toLocaleString()}</p>
                        </div>
                    </div>
                    <p class="text-sm text-slate-300 leading-relaxed">${n.mensaje}</p>
                </div>`;
            }).join('');
        }

        // --- 6. ACCIONES ORIGINALES RESTAURADAS ---
        window.copyRep = (fecha) => {
            const ds = datos.filter(x => x.fecha === fecha);
            const total = ds.reduce((s, d) => s + d.monto, 0);
            const div = divisores[fecha] || 0;
            const res = div > 0 ? total / div : 0;
            let txt = `üìä REPORTE: ${fFec(fecha)}\n--------------------------------\n`;
            ds.forEach(x => txt += `‚Ä¢ ${x.tipo}: ${fNum(x.monto)}\n`);
            txt += `--------------------------------\nüí∞ TOTAL: ${fNum(total)}\n‚úÖ RESULTADO: ${fNum(res)}`;
            navigator.clipboard.writeText(txt).then(() => showToast("Copiado al portapapeles"));
        };

        window.borrarNota = async (idx) => {
            if(await customConfirm("¬øEliminar Nota?", "¬øBorrar este mensaje permanentemente?")) {
                showLoad(true, "Borrando...");
                await post({ action: 'deleteNote', index: idx });
                showToast("Nota eliminada");
                await cargar();
            }
        };

        window.updDiv = async (fecha, val) => {
            divisores[fecha] = val; render();
            await post({ action:'updateDivisor', fecha, divisor: val });
        };

        window.borrar = async (idx) => {
            if(await customConfirm("¬øEliminar?", "¬øBorrar este registro?")) {
                showLoad(true, "Borrando...");
                await post({ action:'delete', index: idx });
                showToast("Registro eliminado");
                await cargar();
            }
        };

        document.getElementById('btnExport').onclick = () => {
            const blob = new Blob([JSON.stringify({datos, notes, divisores}, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `backup_${currentUser}.json`; a.click();
            showToast("Backup descargado");
        };

        document.getElementById('btnImportTrigger').onclick = () => document.getElementById('jsonInput').click();
        document.getElementById('jsonInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const content = JSON.parse(ev.target.result);
                if(await customConfirm("¬øRestaurar?", "Se sobrescribir√°n todos los datos actuales.")) {
                    showLoad(true, "Restaurando...");
                    await post({ action: 'importAll', data: content });
                    await cargar();
                }
            };
            reader.readAsText(e.target.files[0]);
        };

        document.getElementById('btnLimpiar').onclick = async () => {
            if(await customConfirm("¬øVACIAR TODO?", "Esta acci√≥n no se puede deshacer.")) {
                showLoad(true, "Limpiando...");
                await post({ action: 'importAll', data: {datos:[], notes:[], divisores:{}} });
                await cargar();
            }
        };

        document.getElementById('btnNota').onclick = async () => {
            const msg = document.getElementById('notaMsg').value.trim();
            if(!msg) return;
            showLoad(true, "Enviando...");
            await post({ action: 'addNote', autor: currentUser, mensaje: msg });
            document.getElementById('notaMsg').value = '';
            await cargar();
        };

        document.getElementById('agregarForm').onsubmit = async (e) => {
            e.preventDefault();
            const m = parseInt(document.getElementById('monto').value.replace(/\./g,''));
            showLoad(true, "Guardando...");
            await post({ 
                action: 'add', 
                tipo: document.querySelector('input[name="tipo"]:checked').value,
                fecha: document.getElementById('fecha').value,
                monto: m
            });
            document.getElementById('monto').value = '';
            await cargar();
        };

        window.abrirEd = (idx) => {
            editIndex = idx;
            const d = datos.find(x => x.originalIndex === idx);
            document.getElementById('edTipo').value = d.tipo;
            document.getElementById('edFecha').value = d.fecha;
            document.getElementById('edMonto').value = d.monto.toLocaleString('es-ES');
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        };

        document.getElementById('btnSaveEd').onclick = async () => {
            showLoad(true);
            await post({
                action: 'update', sheetIndex: editIndex,
                tipo: document.getElementById('edTipo').value,
                fecha: document.getElementById('edFecha').value,
                monto: parseInt(document.getElementById('edMonto').value.replace(/\./g,''))
            });
            document.getElementById('editModal').classList.add('hidden');
            await cargar();
        };

        document.getElementById('btnProcesar').onclick = async () => {
            const txt = document.getElementById('importText').value;
            const lines = txt.split('\n');
            let curDate = null;
            showLoad(true, "Procesando...");
            for(let l of lines) {
                const fMatch = l.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                if(fMatch) curDate = `${fMatch[3]}-${fMatch[2]}-${fMatch[1]}`;
                const mMatch = l.match(/- (M√°quinas|Mesas|Otras|Otros):\s*\$?([\d.]+)/);
                if(mMatch && curDate) {
                    await post({ action:'add', fecha:curDate, tipo:mMatch[1].replace('Otros','Otras'), monto:parseFloat(mMatch[2].replace(/\./g,'')) });
                }
            }
            document.getElementById('importText').value = '';
            await cargar();
            switchPanel('historialPanel');
        };

        document.getElementById('btnMin').onclick = () => { minimizado = !minimizado; render(); };
        document.getElementById('btnSortDesc').onclick = () => { sortOrder = sortOrder === 'desc' ? 'asc' : 'desc'; render(); };
        document.getElementById('filtro').oninput = render;

        // --- 7. AUTH ORIGINAL ---
        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(p === '1234') {
                currentUser = u;
                sessionStorage.setItem('user', u);
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('activeUserBadge').textContent = `SESI√ìN: ${u.toUpperCase()}`;
                document.getElementById('userAvatar').textContent = u.substring(0,2).toUpperCase();
                document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
                cargar();
            } else { showToast("Clave Incorrecta", "danger"); }
        };

        document.getElementById('toggleLoginPassword').onclick = function() {
            const p = document.getElementById('password');
            const isP = p.type === 'password';
            p.type = isP ? 'text' : 'password';
            this.textContent = isP ? 'visibility_off' : 'visibility';
        };

        document.getElementById('logoutBtn').onclick = () => { 
            sessionStorage.clear(); 
            location.reload(); 
        };

        const savedUser = sessionStorage.getItem('user');
        if(savedUser) {
            document.getElementById('username').value = savedUser;
            document.getElementById('password').value = '1234';
            document.getElementById('loginForm').dispatchEvent(new Event('submit'));
        }
    });
    </script>
</body>
</html>