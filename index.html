<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Recaudaci√≥n Pro v2 - Evoluci√≥n Final</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5855f6">
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#5855f6",
                        "background-dark": "#101022",
                        "surface-dark": "#191834",
                        "border-dark": "#323168",
                        "accent-amber": "#f59e0b",
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .content-panel { display: none; }
        .content-panel.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #1e293b; color: white; padding: 12px 24px; border-radius: 14px; font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 12px; animation: toastIn 0.3s ease-out; pointer-events: auto; }
        @keyframes toastIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-open { overflow: hidden; }
    </style>
</head>

<body class="bg-slate-50 dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 min-h-screen">

    <div id="toast-container"></div>

    <!-- LOADER GLOBAL -->
    <div id="globalLoader" class="fixed inset-0 bg-background-dark/80 backdrop-blur-md hidden items-center justify-center z-[10000]">
        <div class="text-center">
            <div class="size-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin mx-auto"></div>
            <p id="loaderMsg" class="mt-4 text-primary font-bold text-xs uppercase tracking-widest text-white text-center">Sincronizando...</p>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="loginOverlay" class="fixed inset-0 z-[9999] bg-background-dark flex items-center justify-center p-6">
        <div class="w-full max-w-md bg-surface-dark p-8 rounded-[2.5rem] border border-border-dark shadow-2xl text-center">
            <div class="size-16 bg-primary/20 rounded-2xl flex items-center justify-center mb-6 mx-auto border border-primary/30 text-white text-3xl">
                <span class="material-symbols-outlined text-4xl">shield_person</span>
            </div>
            <h2 class="text-2xl font-black mb-8 tracking-tight text-white uppercase">Acceso Profesional</h2>
            <form id="loginForm" class="space-y-4 text-left">
                <label class="text-[10px] font-black text-slate-500 uppercase ml-2">Seleccione Usuario</label>
                <select id="username" class="w-full bg-background-dark border-border-dark rounded-xl py-4 px-5 text-white font-bold focus:ring-2 focus:ring-primary outline-none">
                    <option value="ADMIN">ADMINISTRADOR</option>
                    <option value="MESAS">USUARIO: MESAS</option>
                    <option value="MAQUINAS">USUARIO: M√ÅQUINAS</option>
                </select>
                <label class="text-[10px] font-black text-slate-500 uppercase ml-2">Clave</label>
                <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-background-dark border-border-dark rounded-xl py-4 px-5 text-white focus:ring-2 focus:ring-primary outline-none">
                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white py-4 rounded-xl font-black transition-all active:scale-95 shadow-xl shadow-primary/20 mt-4">INGRESAR AL PANEL</button>
            </form>
        </div>
    </div>

    <!-- HEADER -->
    <header class="sticky top-0 z-40 bg-white/80 dark:bg-background-dark/80 backdrop-blur-md border-b border-slate-200 dark:border-border-dark">
        <div class="flex items-center justify-between p-4 max-w-2xl mx-auto">
            <div class="flex items-center gap-3">
                <div class="size-10 rounded-xl bg-primary/20 flex items-center justify-center border border-primary/30 text-primary">
                    <span class="material-symbols-outlined">analytics</span>
                </div>
                <div>
                    <h1 class="text-md font-black leading-none text-white">Recaudaci√≥n Pro</h1>
                    <p id="activeUserBadge" class="text-[9px] text-primary font-bold uppercase mt-1 tracking-widest"></p>
                </div>
            </div>
            <button id="logoutBtn" class="bg-red-500/10 text-red-500 px-4 py-2 rounded-full text-[10px] font-bold hover:bg-red-500 hover:text-white transition-all uppercase">Cerrar</button>
        </div>
    </header>

    <main id="mainContent" class="max-w-2xl mx-auto pb-32 hidden">
        
        <!-- DASHBOARD -->
        <div class="p-4 grid grid-cols-2 gap-4">
            <div class="bg-white dark:bg-surface-dark p-5 rounded-3xl border border-slate-200 dark:border-border-dark shadow-sm text-center">
                <span class="text-[10px] text-slate-500 font-black uppercase">Recaudaci√≥n Mes</span>
                <p id="tot-rec" class="text-2xl font-black text-primary mt-1">$0</p>
            </div>
            <div class="bg-white dark:bg-surface-dark p-5 rounded-3xl border border-slate-200 dark:border-border-dark shadow-sm text-center">
                <span class="text-[10px] text-slate-500 font-black uppercase">Total Puntos Final</span>
                <p id="tot-div" class="text-2xl font-black text-accent-amber mt-1">$0</p>
            </div>
        </div>

        <!-- AGREGAR -->
        <section id="agregarPanel" class="content-panel active p-4 space-y-6">
            <div class="bg-white dark:bg-surface-dark p-8 rounded-[2.5rem] border border-slate-200 dark:border-border-dark shadow-xl">
                <h3 class="text-lg font-black mb-6 flex items-center gap-3 text-white uppercase justify-center">
                    <span class="material-symbols-outlined text-primary text-3xl">add_circle</span> Nuevo Registro
                </h3>
                <form id="agregarForm" class="space-y-5">
                    <div class="grid grid-cols-3 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="tipo" value="M√°quinas" checked class="peer hidden">
                            <div class="peer-checked:bg-primary peer-checked:text-white bg-slate-100 dark:bg-background-dark p-3 rounded-xl text-center transition-all border border-transparent">
                                <span class="text-[10px] font-black uppercase">M√°quinas</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="tipo" value="Mesas" class="peer hidden">
                            <div class="peer-checked:bg-primary peer-checked:text-white bg-slate-100 dark:bg-background-dark p-3 rounded-xl text-center transition-all border border-transparent">
                                <span class="text-[10px] font-black uppercase">Mesas</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="tipo" value="Otras" class="peer hidden">
                            <div class="peer-checked:bg-primary peer-checked:text-white bg-slate-100 dark:bg-background-dark p-3 rounded-xl text-center transition-all border border-transparent">
                                <span class="text-[10px] font-black uppercase">Otras</span>
                            </div>
                        </label>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-500 uppercase ml-2">Fecha de Ingreso</label>
                        <input type="date" id="fecha" required class="w-full bg-slate-50 dark:bg-background-dark border-slate-200 dark:border-border-dark rounded-xl py-3 text-white font-bold outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-500 uppercase ml-2">Monto Recaudado</label>
                        <input type="tel" id="monto" oninput="formatearMonto(this)" placeholder="0" required class="w-full bg-slate-50 dark:bg-background-dark border-slate-200 dark:border-border-dark rounded-xl py-4 px-5 text-2xl font-black text-primary focus:ring-primary outline-none">
                    </div>
                    <button type="submit" class="w-full bg-primary text-white py-4 rounded-xl font-black text-lg shadow-xl shadow-primary/20 active:scale-95 transition-all uppercase">Guardar Dato</button>
                </form>
            </div>
        </section>

        <!-- HISTORIAL -->
        <section id="historialPanel" class="content-panel p-4 space-y-4">
            <div class="flex flex-wrap gap-2 mb-4">
                <button id="btnMin" class="bg-white dark:bg-surface-dark border border-border-dark px-4 py-2 rounded-full text-[10px] font-black uppercase text-white">Expandir / Min</button>
                <input type="text" id="filtro" placeholder="Buscar fecha..." class="flex-1 bg-white dark:bg-surface-dark border-slate-200 dark:border-border-dark rounded-full px-5 py-2 text-xs text-white">
            </div>

            <div id="tablaContainer" class="space-y-6"></div>

            <!-- GESTI√ìN -->
            <div class="mt-12 p-6 bg-white dark:bg-surface-dark rounded-[2rem] border border-border-dark space-y-6">
                <h4 class="text-[10px] font-black uppercase text-slate-400 flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm">settings_suggest</span> Mantenimiento y Backups
                </h4>
                <div class="grid grid-cols-2 gap-3">
                    <button id="btnExportarJson" class="flex flex-col items-center p-4 bg-primary/10 rounded-2xl border border-primary/20 text-primary active:scale-95 transition-all">
                        <span class="material-symbols-outlined mb-1 text-2xl">file_download</span>
                        <span class="text-[9px] font-black uppercase text-center leading-tight">Exportar JSON</span>
                    </button>
                    <button id="btnImportarTrigger" class="flex flex-col items-center p-4 bg-accent-amber/10 rounded-2xl border border-accent-amber/20 text-accent-amber active:scale-95 transition-all">
                        <span class="material-symbols-outlined mb-1 text-2xl">file_upload</span>
                        <span class="text-[9px] font-black uppercase text-center leading-tight">Importar JSON</span>
                    </button>
                    <button id="btnLimpiar" class="col-span-2 p-4 bg-red-500/10 rounded-2xl border border-red-500/20 text-red-500 font-black text-[11px] uppercase active:scale-95 transition-all">
                        Vaciar Nube y Archivar Todo
                    </button>
                </div>
                <input type="file" id="jsonFileInput" class="hidden" accept=".json">
            </div>
        </section>

        <!-- CARPETAS -->
        <section id="archiveroPanel" class="content-panel p-4 space-y-4">
            <h3 class="text-lg font-black uppercase text-white">Carpetas Archivadas</h3>
            <div id="archiveroContainer" class="space-y-3"></div>
        </section>

        <!-- IMPORTAR REPORTE -->
        <section id="importarPanel" class="content-panel p-4">
            <div class="bg-white dark:bg-surface-dark p-8 rounded-[2.5rem] border border-border-dark shadow-xl">
                <h3 class="text-lg font-black mb-4 text-white uppercase flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">description</span> Importar Reporte
                </h3>
                <textarea id="importText" rows="8" class="w-full bg-slate-100 dark:bg-background-dark border-border-dark rounded-2xl p-4 text-xs mb-4 text-white font-mono outline-none" placeholder="Pega el texto aqu√≠..."></textarea>
                <button id="btnProcesarTexto" class="w-full bg-primary text-white py-4 rounded-xl font-black uppercase active:scale-95 transition-all">Procesar e Importar</button>
            </div>
        </section>

        <!-- NOTAS -->
        <section id="notasPanel" class="content-panel">
            <div class="p-6 bg-white dark:bg-background-dark border-b border-border-dark shadow-sm">
                <textarea id="notaMsg" class="w-full bg-slate-100 dark:bg-surface-dark border-border-dark rounded-2xl p-4 text-sm min-h-[100px] text-white outline-none" placeholder="Escribe una nota para el equipo..."></textarea>
                <button id="btnNota" class="w-full mt-3 bg-primary text-white py-4 rounded-xl font-black text-xs uppercase shadow-lg active:scale-95 transition-all">Publicar Nota</button>
            </div>
            <div id="notesContainer" class="p-4 space-y-4"></div>
        </section>

    </main>

    <!-- TAB BAR -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-background-dark/90 backdrop-blur-xl border-t border-slate-200 dark:border-border-dark px-6 pb-10 pt-4 z-50">
        <div class="flex items-center justify-between max-w-2xl mx-auto overflow-x-auto no-scrollbar gap-4">
            <button class="nav-btn flex flex-col items-center gap-1 text-primary scale-110 shrink-0" data-target="agregarPanel">
                <span class="material-symbols-outlined">add_box</span>
                <span class="text-[9px] font-black uppercase">Agregar</span>
            </button>
            <button class="nav-btn flex flex-col items-center gap-1 text-slate-400 shrink-0" data-target="historialPanel">
                <span class="material-symbols-outlined">history</span>
                <span class="text-[9px] font-black uppercase">Historial</span>
            </button>
            <button class="nav-btn flex flex-col items-center gap-1 text-slate-400 shrink-0" data-target="archiveroPanel">
                <span class="material-symbols-outlined">folder_zip</span>
                <span class="text-[9px] font-black uppercase">Carpetas</span>
            </button>
            <button class="nav-btn flex flex-col items-center gap-1 text-slate-400 shrink-0" data-target="importarPanel">
                <span class="material-symbols-outlined">upload_file</span>
                <span class="text-[9px] font-black uppercase">Importar</span>
            </button>
            <button class="nav-btn flex flex-col items-center gap-1 text-slate-400 shrink-0 relative" data-target="notasPanel">
                <span class="material-symbols-outlined">forum</span>
                <span id="ind-notas" class="absolute top-0 right-0 size-2 bg-accent-amber rounded-full hidden"></span>
                <span class="text-[9px] font-black uppercase">Notas</span>
            </button>
        </div>
    </nav>

    <!-- MODAL ARCHIVO -->
    <div id="archivoModal" class="fixed inset-0 z-[100] bg-background-dark hidden flex-col h-screen w-full">
        <header class="p-4 border-b border-border-dark flex justify-between items-center bg-surface-dark shrink-0">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-primary">folder_open</span>
                <h3 id="archivoModalTitulo" class="text-sm font-black uppercase text-white leading-none">Detalle Carpeta</h3>
            </div>
            <button onclick="cerrarArchivo()" class="bg-red-500/20 text-red-500 px-4 py-2 rounded-full text-[10px] font-black uppercase">Cerrar</button>
        </header>
        <div id="archivoModalContenido" class="flex-1 overflow-y-auto p-4 space-y-6 pb-24"></div>
    </div>

    <!-- MODAL CONFIRMACI√ìN -->
    <div id="confirmModal" class="fixed inset-0 z-[100] bg-background-dark/90 backdrop-blur-sm hidden items-center justify-center p-6 text-center">
        <div class="w-full max-w-sm bg-surface-dark p-8 rounded-[2.5rem] border border-border-dark shadow-2xl">
            <h3 id="confirmTitle" class="text-lg font-black mb-2 text-white uppercase tracking-tighter">¬øConfirmar?</h3>
            <p id="confirmMsg" class="text-slate-400 text-sm mb-8 leading-relaxed"></p>
            <div class="flex gap-3">
                <button id="confirmBtnYes" class="flex-1 bg-red-500 text-white py-4 rounded-xl font-black uppercase text-xs">Confirmar</button>
                <button id="confirmBtnNo" class="flex-1 bg-slate-800 text-slate-400 py-4 rounded-xl font-black uppercase text-xs">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz_kCb4aEe437zHGbRqnjCibw1NtAqfCbTNmsVPn9jaZOPBFaZ6-FwmiTLqVxq39X1P/exec';
        let datos = [], notes = [], divisores = {}, minimizado = true, currentUser = '';
        let archivero = JSON.parse(localStorage.getItem('carpetas_recaudacion_pro_v3') || '[]');
        let debounceTimer;

        // --- FORMATEO FECHA: "Lunes, 15/02/2026" ---
        const fFec = (f, incluyeHora = false) => {
            if (!f) return '';
            const d = incluyeHora ? new Date(f) : new Date(f + 'T12:00:00');
            const opciones = { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' };
            if (incluyeHora) { 
                opciones.hour = '2-digit'; opciones.minute = '2-digit'; 
            }
            let res = d.toLocaleDateString('es-ES', opciones);
            return res.charAt(0).toUpperCase() + res.slice(1);
        };

        const fNum = (n) => `$${Math.floor(n || 0).toLocaleString('es-ES')}`;
        
        window.formatearMonto = (input) => {
            let v = input.value.replace(/\D/g, '');
            input.value = v ? parseInt(v).toLocaleString('es-ES') : '';
        };

        const showToast = (msg, icon = 'check_circle') => {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerHTML = `<span class="material-symbols-outlined text-green-400">${icon}</span> ${msg}`;
            c.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 400); }, 3000);
        };

        const customConfirm = (title, msg) => new Promise(resolve => {
            const m = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMsg').textContent = msg;
            m.classList.remove('hidden'); m.classList.add('flex');
            document.getElementById('confirmBtnYes').onclick = () => { m.classList.add('hidden'); resolve(true); };
            document.getElementById('confirmBtnNo').onclick = () => { m.classList.add('hidden'); resolve(false); };
        });

        const showLoad = (s, msg = "Sincronizando...") => {
            document.getElementById('loaderMsg').textContent = msg;
            document.getElementById('globalLoader').style.display = s ? 'flex' : 'none';
        };

        async function post(data) {
            return fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify(data) }).then(r => r.json());
        }

        async function cargarTodo(loader = true) {
            if(loader) showLoad(true);
            try {
                const url = new URL(SCRIPT_URL);
                const [d, n, v] = await Promise.all([
                    fetch(url + "?action=get").then(r => r.json()),
                    fetch(url + "?action=getNotes").then(r => r.json()),
                    fetch(url + "?action=getDivisores").then(r => r.json())
                ]);
                datos = d.data || []; notes = n.data || []; divisores = v.data || {};
                render();
            } catch(e) { showToast("Error de conexi√≥n", "error"); }
            finally { if(loader) showLoad(false); }
        }

        function render() {
            const totalRec = datos.reduce((s, d) => s + d.monto, 0);
            document.getElementById('tot-rec').textContent = fNum(totalRec);
            
            const container = document.getElementById('tablaContainer');
            container.innerHTML = '';
            
            const grouped = datos.reduce((acc, d) => { (acc[d.fecha] = acc[d.fecha] || []).push(d); return acc; }, {});
            const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));
            
            let totalGeneralPtos = 0;
            sortedDates.forEach((fecha, i) => {
                const diaTot = grouped[fecha].reduce((s, d) => s + d.monto, 0);
                const divVal = divisores[fecha] || 0;
                const resDiv = divVal > 0 ? diaTot / divVal : 0;
                totalGeneralPtos += resDiv;

                if (minimizado && i > 0 && !document.getElementById('filtro').value) return;
                container.innerHTML += crearCardFecha(fecha, grouped[fecha], divVal, resDiv, true);
            });
            document.getElementById('tot-div').textContent = fNum(totalGeneralPtos);
            renderNotes();
            renderArchivero();
        }

        function crearCardFecha(fecha, registros, divVal, resDiv, editable) {
            const diaTot = registros.reduce((s, d) => s + d.monto, 0);
            const rows = registros.map(d => `
                <div class="flex justify-between items-center py-3 border-b border-border-dark/30 last:border-0">
                    <div>
                        <span class="text-[9px] font-black text-primary uppercase leading-none">${d.tipo}</span>
                        <p class="text-sm font-bold text-white">${fNum(d.monto)}</p>
                    </div>
                    ${editable ? `<button onclick="borrarRegistro(${d.originalIndex})" class="text-red-500 opacity-20 hover:opacity-100 transition-all"><span class="material-symbols-outlined text-sm">delete</span></button>` : ''}
                </div>`).join('');

            return `
                <div class="bg-white dark:bg-surface-dark rounded-[2.5rem] border border-border-dark overflow-hidden">
                    <div class="p-5 bg-background-dark/40 border-b border-border-dark flex justify-between items-center">
                        <h4 class="text-xs font-black uppercase text-primary tracking-tighter">${fFec(fecha)}</h4>
                        <button onclick="copiarDia('${fecha}')" class="text-slate-500"><span class="material-symbols-outlined text-sm">content_copy</span></button>
                    </div>
                    <div class="px-6 py-2">${rows}</div>
                    <div class="p-6 bg-background-dark/20 border-t border-border-dark grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-[9px] font-black text-slate-500 uppercase block leading-none mb-1">Total Noche</span>
                            <span class="text-lg font-black text-white">${fNum(diaTot)}</span>
                        </div>
                        <div class="text-right">
                            <div class="flex flex-col items-end">
                                <span class="text-[9px] font-black text-primary uppercase block leading-none mb-1">Ptos Div:</span>
                                ${editable ? `
                                <input type="number" step="any" value="${divVal || ''}" 
                                    oninput="silenciosoDivisor('${fecha}', this.value)" 
                                    class="w-16 bg-background-dark border border-border-dark rounded-lg text-center text-accent-amber font-black text-xs py-1 outline-none">
                                ` : `<span class="text-white font-black">${divVal}</span>`}
                                <span id="res-${fecha}" class="text-xl font-black text-accent-amber mt-1">${fNum(resDiv)}</span>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        window.silenciosoDivisor = (fecha, valor) => {
            const v = parseFloat(valor) || 0;
            divisores[fecha] = v;
            const diaTot = datos.filter(d => d.fecha === fecha).reduce((s,d) => s + d.monto, 0);
            const res = v > 0 ? diaTot / v : 0;
            document.getElementById(`res-${fecha}`).textContent = fNum(res);
            
            let totalGeneralPtos = 0;
            const grouped = datos.reduce((acc, d) => { (acc[d.fecha] = acc[d.fecha] || []).push(d); return acc; }, {});
            Object.keys(grouped).forEach(f => {
                const tD = grouped[f].reduce((s, d) => s + d.monto, 0);
                const dV = divisores[f] || 0;
                if(dV > 0) totalGeneralPtos += (tD / dV);
            });
            document.getElementById('tot-div').textContent = fNum(totalGeneralPtos);

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                await post({ action: 'updateDivisor', fecha, divisor: v });
            }, 1000);
        };

        function renderArchivero() {
            const container = document.getElementById('archiveroContainer');
            if(archivero.length === 0) {
                container.innerHTML = `<p class="text-center py-10 text-[10px] uppercase opacity-20">No hay carpetas</p>`;
                return;
            }
            container.innerHTML = archivero.map((arc, idx) => `
                <div class="bg-surface-dark border border-border-dark p-5 rounded-3xl flex justify-between items-center shadow-md">
                    <div>
                        <h5 class="text-xs font-black text-white uppercase">${arc.rango}</h5>
                        <p class="text-[10px] font-bold text-slate-500 mt-1 uppercase">${arc.totalRec} | ${arc.totalPtos}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="verArchivo(${idx})" class="size-10 rounded-xl bg-primary text-white flex items-center justify-center"><span class="material-symbols-outlined">visibility</span></button>
                        <button onclick="eliminarCarpeta(${idx})" class="size-10 rounded-xl bg-red-500/10 text-red-500 flex items-center justify-center"><span class="material-symbols-outlined">delete</span></button>
                    </div>
                </div>`).join('');
        }

        window.verArchivo = (idx) => {
            const arc = archivero[idx];
            const cont = document.getElementById('archivoModalContenido');
            document.getElementById('archivoModalTitulo').textContent = `Carpeta: ${arc.rango}`;
            cont.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                    <div class="bg-primary/10 border border-primary/20 p-5 rounded-[2rem]">
                        <span class="text-[9px] font-black text-primary uppercase block mb-1 leading-none">Recaudaci√≥n Final</span>
                        <span class="text-xl font-black text-white">${arc.totalRec}</span>
                    </div>
                    <div class="bg-accent-amber/10 border border-accent-amber/20 p-5 rounded-[2rem]">
                        <span class="text-[9px] font-black text-accent-amber uppercase block mb-1 leading-none">Puntos Final</span>
                        <span class="text-xl font-black text-white">${arc.totalPtos}</span>
                    </div>
                </div>
            `;
            const grouped = arc.data.reduce((acc, d) => { (acc[d.fecha] = acc[d.fecha] || []).push(d); return acc; }, {});
            const sorted = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));
            sorted.forEach(f => {
                const diaTot = grouped[f].reduce((s,d) => s + d.monto, 0);
                const divVal = arc.divisores[f] || 0;
                cont.innerHTML += crearCardFecha(f, grouped[f], divVal, divVal>0?diaTot/divVal:0, false);
            });
            document.body.classList.add('modal-open');
            document.getElementById('archivoModal').classList.replace('hidden', 'flex');
        };

        window.cerrarArchivo = () => {
            document.body.classList.remove('modal-open');
            document.getElementById('archivoModal').classList.replace('flex', 'hidden');
        };

        window.eliminarCarpeta = async (idx) => {
            if(await customConfirm("¬øBorrar Carpeta?", "Se eliminar√° permanentemente de este equipo.")) {
                archivero.splice(idx, 1);
                localStorage.setItem('carpetas_recaudacion_pro_v3', JSON.stringify(archivero));
                renderArchivero();
            }
        };

        // --- VACIAR NUBE Y ARCHIVAR (PROTEGIENDO NOTAS) ---
        document.getElementById('btnLimpiar').onclick = async () => {
            if(datos.length === 0) return;
            if(await customConfirm("¬øVACIAR Y ARCHIVAR?", "Se crear√° una carpeta detallada local. Los registros y divisores se borrar√°n de la nube, pero las NOTAS se mantendr√°n.")) {
                showLoad(true, "Archivando y Limpiando...");
                const sorted = datos.map(d => d.fecha).sort();
                const totalR = datos.reduce((s,d) => s + d.monto, 0);
                
                // Guardar localmente
                archivero.push({
                    rango: `${fFec(sorted[0])} - ${fFec(sorted[sorted.length-1])}`,
                    totalRec: fNum(totalR),
                    totalPtos: document.getElementById('tot-div').textContent,
                    data: JSON.parse(JSON.stringify(datos)),
                    divisores: JSON.parse(JSON.stringify(divisores))
                });
                localStorage.setItem('carpetas_recaudacion_pro_v3', JSON.stringify(archivero));

                // Limpiar en nube enviando los datos vac√≠os PERO manteniendo el array actual de notes
                await post({ 
                    action: 'importAll', 
                    data: {
                        datos: [], 
                        notes: notes, // REENVIAR NOTAS ACTUALES PARA QUE NO SE BORREN
                        divisores: {} 
                    } 
                });

                await cargarTodo();
                showToast("Mes archivado. Notas conservadas.");
            }
        };

        // --- BACKUPS ---
        document.getElementById('btnExportarJson').onclick = () => {
            const backup = { datos, notes, divisores, archivero };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `BACKUP_TOTAL_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            showToast("Backup completo descargado");
        };

        document.getElementById('btnImportarTrigger').onclick = () => document.getElementById('jsonFileInput').click();
        document.getElementById('jsonFileInput').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const content = JSON.parse(ev.target.result);
                    if(await customConfirm("¬øRestaurar Backup?", "Se sobrescribir√°n los datos de la nube y el archivero local.")) {
                        showLoad(true, "Sincronizando...");
                        await post({ action: 'importAll', data: content });
                        if(content.archivero) {
                            archivero = content.archivero;
                            localStorage.setItem('carpetas_recaudacion_pro_v3', JSON.stringify(archivero));
                        }
                        await cargarTodo();
                        showToast("Sistema restaurado con √©xito");
                    }
                } catch(err) { showToast("Archivo JSON inv√°lido", "error"); }
            };
            reader.readAsText(file);
            e.target.value = '';
        };

        document.getElementById('btnProcesarTexto').onclick = async () => {
            const texto = document.getElementById('importText').value;
            if(!texto) return;
            showLoad(true, "Importando...");
            const lines = texto.split('\n');
            let curFecha = null;
            for(let l of lines) {
                const fMatch = l.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                if(fMatch) curFecha = `${fMatch[3]}-${fMatch[2]}-${fMatch[1]}`;
                const mMatch = l.match(/- (M√°quinas|Mesas|Otras|Otros):\s*\$?([\d.]+)/);
                if(mMatch && curFecha) {
                    await post({ action:'add', fecha:curFecha, tipo:mMatch[1].replace('Otros','Otras'), monto:parseFloat(mMatch[2].replace(/\./g,'')) });
                }
            }
            document.getElementById('importText').value = '';
            await cargarTodo();
            showToast("Importaci√≥n finalizada");
        };

        // --- NOTAS (AUTOR Y FECHA "Lunes...") ---
        function renderNotes() {
            const container = document.getElementById('notesContainer');
            container.innerHTML = notes.slice().reverse().map(n => {
                const autor = n.autor || 'Desconocido';
                const inicial = autor.charAt(0).toUpperCase();
                
                return `
                <div class="bg-surface-dark p-6 rounded-[2rem] border-l-4 border-primary relative shadow-md">
                    <button onclick="borrarNota(${n.originalIndex})" class="absolute top-4 right-4 text-red-500 opacity-20 hover:opacity-100 transition-all"><span class="material-symbols-outlined text-sm">delete</span></button>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="size-10 rounded-xl bg-primary/20 flex items-center justify-center text-primary font-black border border-primary/20">${inicial}</div>
                        <div>
                            <p class="text-xs font-black text-white uppercase leading-none">${autor}</p>
                            <p class="text-[9px] font-bold text-slate-500 uppercase mt-1 tracking-widest">${fFec(n.fecha, true)}</p>
                        </div>
                    </div>
                    <p class="text-sm text-slate-300 leading-relaxed font-medium">${n.mensaje}</p>
                </div>`;
            }).join('');
        }

        window.borrarRegistro = async (idx) => {
            if(await customConfirm("¬øBorrar Registro?", "Se eliminar√° de la nube permanentemente.")) {
                showLoad(true); await post({ action:'delete', index: idx }); await cargarTodo();
            }
        };

        window.borrarNota = async (idx) => {
            if(await customConfirm("¬øBorrar Nota?", "")) {
                showLoad(true); await post({ action:'deleteNote', index: idx }); await cargarTodo();
            }
        };

        window.copiarDia = (fecha) => {
            const items = datos.filter(d => d.fecha === fecha);
            const total = items.reduce((s,d) => s + d.monto, 0);
            const div = divisores[fecha] || 0;
            let txt = `üìä REPORTE ${fFec(fecha)}\n`;
            items.forEach(i => txt += `‚Ä¢ ${i.tipo}: ${fNum(i.monto)}\n`);
            txt += `üí∞ TOTAL: ${fNum(total)}\n‚úÖ RES: ${fNum(div>0?total/div:0)}`;
            navigator.clipboard.writeText(txt).then(() => showToast("Copiado"));
        };

        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            if(document.getElementById('password').value === '1234') {
                currentUser = document.getElementById('username').value;
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('activeUserBadge').textContent = `SESI√ìN: ${currentUser}`;
                document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
                cargarTodo();
                setInterval(() => cargarTodo(false), 300000); 
            } else { alert("Clave Incorrecta"); }
        };

        document.getElementById('btnNota').onclick = async () => {
            const msg = document.getElementById('notaMsg').value.trim();
            if(!msg) return;
            showLoad(true, "Publicando...");
            await post({ action:'addNote', autor: currentUser, mensaje: msg });
            document.getElementById('notaMsg').value = ''; 
            await cargarTodo();
            showToast("Nota publicada");
        };

        document.getElementById('agregarForm').onsubmit = async (e) => {
            e.preventDefault();
            const mStr = document.getElementById('monto').value.replace(/\./g,'');
            if(!mStr) return;
            showLoad(true, "Guardando...");
            await post({ action: 'add', tipo: document.querySelector('input[name="tipo"]:checked').value, fecha: document.getElementById('fecha').value, monto: parseInt(mStr) });
            document.getElementById('monto').value = ''; await cargarTodo();
            showToast("Registro guardado");
        };

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.onclick = () => {
                const target = btn.dataset.target;
                document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(target).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('text-primary', 'scale-110');
                    b.classList.add('text-slate-400');
                });
                btn.classList.add('text-primary', 'scale-110');
                btn.classList.remove('text-slate-400');
                window.scrollTo({top: 0, behavior: 'smooth'});
            };
        });

        document.getElementById('btnMin').onclick = () => { minimizado = !minimizado; render(); };
        document.getElementById('logoutBtn').onclick = () => location.reload();
    });
    </script>
</body>
</html>